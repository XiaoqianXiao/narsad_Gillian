Bootstrap: localimage
From: /mmfs1/home/xxqian/repos/images/narsad-fmri_1st_level_0.0.sif

%environment
    export DEBIAN_FRONTEND=noninteractive
    export FSLDIR=/usr/local/fsl
    export PATH=${FSLDIR}/bin:$PATH
    export FSLOUTPUTTYPE=NIFTI_GZ
    export PYTHONUNBUFFERED=1
    export MPLBACKEND=Agg  # safe for headless plotting in Apptainer

%files
    S1_create_ROIs.py /app/S1_create_ROIs.py
    S2_1st_level.py /app/S2_1st_level.py

%post
    # Ensure environment
    export DEBIAN_FRONTEND=noninteractive

    # Update pip and install missing Python dependencies
    pip3 install --upgrade pip
    pip3 install \
        numpy \
        pandas \
        bids \
        nipype \
        templateflow \
        nilearn \
        nibabel \
        nltools \
        matplotlib \
        seaborn \
        scikit-learn \
        joblib \
        openpyxl

    # Make scripts executable
    chmod +x /app/S1_create_ROIs.py
    chmod +x /app/S2_1st_level.py

%runscript
    #!/bin/bash
    CMD="$1"; shift || true
    case "$CMD" in
      standard)
        exec python3 /app/S1_create_ROIs.py "$@" ;;
      single_trial)
        exec python3 /app/S2_1st_level.py "$@" ;;
      *)
        echo "Usage: $(basename $0) {standard|single_trial} [args...]" >&2
        exit 1
        ;;
    esac